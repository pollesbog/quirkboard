<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canvas Notes - Collaborative Board</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            overflow: hidden;
            background: #f5f5f7;
        }

        #canvas-container {
            width: 100vw;
            height: 100vh;
            position: relative;
            overflow: hidden;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        #canvas {
            width: 100%;
            height: 100%;
            position: absolute;
            cursor: grab;
            transform-origin: 0 0;
            transition: none;
        }

        #canvas.dragging {
            cursor: grabbing;
        }

        #canvas.placing {
            cursor: crosshair;
        }

        /* Toolbar */
        .toolbar {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            padding: 8px;
            z-index: 1000;
            display: flex;
            gap: 4px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.8);
        }

        .toolbar-section {
            display: flex;
            gap: 4px;
            padding: 0 4px;
            align-items: center;
        }

        .toolbar-section:not(:last-child) {
            border-right: 1px solid #e0e0e0;
            padding-right: 8px;
            margin-right: 4px;
        }

        .tool-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            position: relative;
            color: #333;
        }

        .tool-btn:hover {
            background: rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }

        .tool-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .tool-btn svg {
            width: 20px;
            height: 20px;
        }

        .tooltip {
            position: absolute;
            bottom: -35px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }

        .tool-btn:hover .tooltip {
            opacity: 1;
        }

        /* Zoom indicator */
        .zoom-indicator {
            padding: 4px 12px;
            background: rgba(255,255,255,0.9);
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            color: #666;
            min-width: 50px;
            text-align: center;
        }

        /* Note styles */
        .note-container {
            position: absolute;
            z-index: 10;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .point {
            width: 12px;
            height: 12px;
            background: #fff;
            border: 2px solid #333;
            border-radius: 50%;
            position: absolute;
            transform: translate(-50%, -50%);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .point:hover {
            transform: translate(-50%, -50%) scale(1.2);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .speech-bubble {
            position: absolute;
            background: white;
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            min-width: 250px;
            max-width: 400px;
            left: 15px;
            top: -10px;
            transition: opacity 0.5s ease;
        }

        .speech-bubble::before {
            content: '';
            position: absolute;
            left: -10px;
            top: 15px;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 10px 10px 10px 0;
            border-color: transparent white transparent transparent;
        }

        .speech-bubble.editing {
            z-index: 100;
            min-width: 300px;
        }

        /* Rich text editor */
        .rich-editor {
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            overflow: hidden;
        }

        .editor-toolbar {
            background: #f8f8f8;
            padding: 6px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            gap: 4px;
        }

        .editor-btn {
            width: 28px;
            height: 28px;
            border: none;
            background: transparent;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .editor-btn:hover {
            background: #e0e0e0;
        }

        .editor-btn.active {
            background: #667eea;
            color: white;
        }

        .editor-content {
            min-height: 60px;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            outline: none;
            font-size: 14px;
            line-height: 1.5;
        }

        .editor-content:focus {
            background: #fafafa;
        }

        /* Image upload */
        .image-upload-btn {
            position: relative;
            overflow: hidden;
        }

        .image-upload-btn input[type="file"] {
            position: absolute;
            left: -9999px;
        }

        .uploaded-image {
            max-width: 100%;
            border-radius: 6px;
            margin-top: 8px;
        }

        /* Action buttons */
        .bubble-actions {
            margin-top: 8px;
            display: flex;
            gap: 8px;
        }

        .bubble-actions button {
            padding: 6px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .bubble-actions button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.4);
        }

        .bubble-actions button.cancel {
            background: #e0e0e0;
            color: #666;
        }

        /* Display mode */
        .note-content {
            font-size: 14px;
            line-height: 1.5;
            color: #333;
            word-wrap: break-word;
        }

        .note-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .note-actions {
            display: flex;
            gap: 4px;
        }

        .note-action-btn {
            width: 24px;
            height: 24px;
            border: none;
            background: transparent;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            transition: all 0.2s ease;
        }

        .note-action-btn:hover {
            background: #f0f0f0;
            color: #333;
        }

        .timestamp {
            font-size: 11px;
            color: #888;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #f0f0f0;
        }

        /* Info panel */
        .info-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.98);
            padding: 12px 16px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            font-size: 13px;
            color: #666;
            z-index: 1000;
            backdrop-filter: blur(10px);
            display: flex;
            gap: 20px;
        }

        /* Grid background */
        .grid-background {
            position: absolute;
            width: 200%;
            height: 200%;
            background-image: 
                linear-gradient(rgba(255,255,255,0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div id="canvas-container">
        <div class="grid-background"></div>
        <div id="canvas"></div>
    </div>

    <!-- Toolbar -->
    <div class="toolbar">
        <div class="toolbar-section">
            <button class="tool-btn active" id="selectTool" title="Select">
                <svg fill="currentColor" viewBox="0 0 24 24"><path d="M3 5l7-3v18l-7-3V5zm11 3l7-3v18l-7 3V8z"/></svg>
                <span class="tooltip">Select & Pan (V)</span>
            </button>
            <button class="tool-btn" id="noteTool" title="Add Note">
                <svg fill="currentColor" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
                <span class="tooltip">Add Note (N)</span>
            </button>
            <button class="tool-btn" id="imageTool" title="Add Image">
                <svg fill="currentColor" viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
                <span class="tooltip">Add Image (I)</span>
            </button>
        </div>
        
        <div class="toolbar-section">
            <button class="tool-btn" id="zoomOut" title="Zoom Out">
                <svg fill="currentColor" viewBox="0 0 24 24"><path d="M19 13H5v-2h14v2z"/></svg>
                <span class="tooltip">Zoom Out (-)</span>
            </button>
            <div class="zoom-indicator" id="zoomLevel">100%</div>
            <button class="tool-btn" id="zoomIn" title="Zoom In">
                <svg fill="currentColor" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                <span class="tooltip">Zoom In (+)</span>
            </button>
            <button class="tool-btn" id="zoomReset" title="Reset View">
                <svg fill="currentColor" viewBox="0 0 24 24"><path d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/></svg>
                <span class="tooltip">Reset View (R)</span>
            </button>
        </div>

        <div class="toolbar-section">
            <button class="tool-btn" id="clearAll" title="Clear All">
                <svg fill="currentColor" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                <span class="tooltip">Clear All</span>
            </button>
        </div>
    </div>

    <!-- Info Panel -->
    <div class="info-panel">
        <div>Notes: <span id="noteCount">0</span></div>
        <div>Position: <span id="position">0, 0</span></div>
    </div>

    <script>
        // State management
        const state = {
            tool: 'select',
            scale: 1,
            translateX: 0,
            translateY: 0,
            isDragging: false,
            dragStart: { x: 0, y: 0 },
            notes: [],
            activeInput: null,
            noteIdCounter: 0
        };

        // DOM elements
        const canvas = document.getElementById('canvas');
        const container = document.getElementById('canvas-container');
        const zoomLevel = document.getElementById('zoomLevel');
        const noteCountEl = document.getElementById('noteCount');
        const positionEl = document.getElementById('position');
        const grid = document.querySelector('.grid-background');

        // Load saved data
        function loadNotes() {
            const saved = localStorage.getItem('canvasNotes');
            if (saved) {
                state.notes = JSON.parse(saved);
                state.noteIdCounter = Math.max(...state.notes.map(n => n.id), 0) + 1;
                renderAllNotes();
            }
        }

        function saveNotes() {
            localStorage.setItem('canvasNotes', JSON.stringify(state.notes));
            noteCountEl.textContent = state.notes.length;
        }

        // Transform functions
        function updateTransform() {
            canvas.style.transform = `translate(${state.translateX}px, ${state.translateY}px) scale(${state.scale})`;
            grid.style.transform = `translate(${state.translateX}px, ${state.translateY}px) scale(${state.scale})`;
            zoomLevel.textContent = Math.round(state.scale * 100) + '%';
        }

        function screenToCanvas(screenX, screenY) {
            const rect = container.getBoundingClientRect();
            const x = (screenX - rect.left - state.translateX) / state.scale;
            const y = (screenY - rect.top - state.translateY) / state.scale;
            return { x, y };
        }

        // Tool selection
        document.getElementById('selectTool').onclick = () => setTool('select');
        document.getElementById('noteTool').onclick = () => setTool('note');
        document.getElementById('imageTool').onclick = () => setTool('image');

        function setTool(tool) {
            state.tool = tool;
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            
            if (tool === 'select') {
                document.getElementById('selectTool').classList.add('active');
                canvas.classList.remove('placing');
            } else if (tool === 'note') {
                document.getElementById('noteTool').classList.add('active');
                canvas.classList.add('placing');
            } else if (tool === 'image') {
                document.getElementById('imageTool').classList.add('active');
                canvas.classList.add('placing');
            }
        }

        // Zoom controls
        document.getElementById('zoomIn').onclick = () => {
            state.scale = Math.min(state.scale * 1.2, 3);
            updateTransform();
        };

        document.getElementById('zoomOut').onclick = () => {
            state.scale = Math.max(state.scale / 1.2, 0.3);
            updateTransform();
        };

        document.getElementById('zoomReset').onclick = () => {
            state.scale = 1;
            state.translateX = 0;
            state.translateY = 0;
            updateTransform();
        };

        // Clear all
        document.getElementById('clearAll').onclick = () => {
            if (confirm('Clear all notes? This cannot be undone.')) {
                state.notes = [];
                saveNotes();
                document.querySelectorAll('.note-container').forEach(el => el.remove());
            }
        };

        // Pan functionality
        container.addEventListener('mousedown', (e) => {
            if (state.tool === 'select' && e.target === canvas) {
                state.isDragging = true;
                state.dragStart = { x: e.clientX - state.translateX, y: e.clientY - state.translateY };
                canvas.classList.add('dragging');
            }
        });

        document.addEventListener('mousemove', (e) => {
            const pos = screenToCanvas(e.clientX, e.clientY);
            positionEl.textContent = `${Math.round(pos.x)}, ${Math.round(pos.y)}`;
            
            if (state.isDragging) {
                state.translateX = e.clientX - state.dragStart.x;
                state.translateY = e.clientY - state.dragStart.y;
                updateTransform();
            }
        });

        document.addEventListener('mouseup', () => {
            state.isDragging = false;
            canvas.classList.remove('dragging');
        });

        // Canvas click handler
        canvas.addEventListener('click', (e) => {
            if (state.tool === 'note' && !state.isDragging) {
                const pos = screenToCanvas(e.clientX, e.clientY);
                createNote(pos.x, pos.y);
            } else if (state.tool === 'image' && !state.isDragging) {
                const pos = screenToCanvas(e.clientX, e.clientY);
                createImageNote(pos.x, pos.y);
            }
        });

        // Create note with rich text editor
        function createNote(x, y, existingNote = null) {
            if (state.activeInput) {
                state.activeInput.remove();
                state.activeInput = null;
            }

            const noteContainer = document.createElement('div');
            noteContainer.className = 'note-container';
            noteContainer.style.left = x + 'px';
            noteContainer.style.top = y + 'px';

            const point = document.createElement('div');
            point.className = 'point';

            const bubble = document.createElement('div');
            bubble.className = 'speech-bubble editing';

            // Rich text editor
            const editor = document.createElement('div');
            editor.className = 'rich-editor';

            const toolbar = document.createElement('div');
            toolbar.className = 'editor-toolbar';

            // Editor buttons
            const boldBtn = createEditorButton('B', 'bold');
            const italicBtn = createEditorButton('I', 'italic');
            const underlineBtn = createEditorButton('U', 'underline');
            const imageBtn = createImageButton();

            toolbar.appendChild(boldBtn);
            toolbar.appendChild(italicBtn);
            toolbar.appendChild(underlineBtn);
            toolbar.appendChild(imageBtn);

            const editorContent = document.createElement('div');
            editorContent.className = 'editor-content';
            editorContent.contentEditable = true;
            editorContent.innerHTML = existingNote ? existingNote.html : '';

            editor.appendChild(toolbar);
            editor.appendChild(editorContent);

            const actions = document.createElement('div');
            actions.className = 'bubble-actions';

            const submitBtn = document.createElement('button');
            submitBtn.textContent = existingNote ? 'Save' : 'Submit';

            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'cancel';
            cancelBtn.textContent = 'Cancel';

            actions.appendChild(submitBtn);
            actions.appendChild(cancelBtn);

            bubble.appendChild(editor);
            bubble.appendChild(actions);
            noteContainer.appendChild(point);
            noteContainer.appendChild(bubble);
            canvas.appendChild(noteContainer);

            state.activeInput = noteContainer;
            editorContent.focus();

            // Handle submit
            submitBtn.onclick = () => {
                const html = editorContent.innerHTML.trim();
                if (html) {
                    if (existingNote) {
                        existingNote.html = html;
                        existingNote.timestamp = new Date().toISOString();
                        saveNotes();
                        renderAllNotes();
                    } else {
                        const note = {
                            id: state.noteIdCounter++,
                            x: x,
                            y: y,
                            html: html,
                            timestamp: new Date().toISOString()
                        };
                        state.notes.push(note);
                        saveNotes();
                        displayNote(note);
                    }
                    noteContainer.remove();
                    state.activeInput = null;
                } else {
                    noteContainer.remove();
                    state.activeInput = null;
                }
            };

            cancelBtn.onclick = () => {
                noteContainer.remove();
                state.activeInput = null;
            };

            // Format buttons
            boldBtn.onclick = () => document.execCommand('bold');
            italicBtn.onclick = () => document.execCommand('italic');
            underlineBtn.onclick = () => document.execCommand('underline');
        }

        function createEditorButton(text, command) {
            const btn = document.createElement('button');
            btn.className = 'editor-btn';
            btn.innerHTML = `<strong>${text}</strong>`;
            btn.onmousedown = (e) => e.preventDefault();
            return btn;
        }

        function createImageButton() {
            const btn = document.createElement('button');
            btn.className = 'editor-btn image-upload-btn';
            btn.innerHTML = '📷';
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        document.execCommand('insertImage', false, e.target.result);
                    };
                    reader.readAsDataURL(file);
                }
            };
            
            btn.appendChild(input);
            btn.onclick = () => input.click();
            btn.onmousedown = (e) => e.preventDefault();
            
            return btn;
        }

        function createImageNote(x, y) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const note = {
                            id: state.noteIdCounter++,
                            x: x,
                            y: y,
                            html: `<img src="${e.target.result}" style="max-width: 300px; border-radius: 8px;">`,
                            timestamp: new Date().toISOString()
                        };
                        state.notes.push(note);
                        saveNotes();
                        displayNote(note);
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }

        function displayNote(note) {
            const noteContainer = document.createElement('div');
            noteContainer.className = 'note-container';
            noteContainer.style.left = note.x + 'px';
            noteContainer.style.top = note.y + 'px';
            noteContainer.dataset.noteId = note.id;

            const point = document.createElement('div');
            point.className = 'point';

            const bubble = document.createElement('div');
            bubble.className = 'speech-bubble';

            const header = document.createElement('div');
            header.className = 'note-header';

            const actions = document.createElement('div');
            actions.className = 'note-actions';

            const editBtn = document.createElement('button');
            editBtn.className = 'note-action-btn';
            editBtn.innerHTML = '✏️';
            editBtn.title = 'Edit';
            editBtn.onclick = (e) => {
                e.stopPropagation();
                noteContainer.remove();
                createNote(note.x, note.y, note);
            };

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'note-action-btn';
            deleteBtn.innerHTML = '🗑️';
            deleteBtn.title = 'Delete';
            deleteBtn.onclick = (e) => {
                e.stopPropagation();
                if (confirm('Delete this note?')) {
                    state.notes = state.notes.filter(n => n.id !== note.id);
                    saveNotes();
                    noteContainer.remove();
                }
            };

            actions.appendChild(editBtn);
            actions.appendChild(deleteBtn);
            header.appendChild(actions);

            const content = document.createElement('div');
            content.className = 'note-content';
            content.innerHTML = note.html;

            const timestamp = document.createElement('div');
            timestamp.className = 'timestamp';
            timestamp.textContent = new Date(note.timestamp).toLocaleString();

            bubble.appendChild(header);
            bubble.appendChild(content);
            bubble.appendChild(timestamp);
            noteContainer.appendChild(point);
            noteContainer.appendChild(bubble);
            canvas.appendChild(noteContainer);

            updateOpacities();
        }

        function renderAllNotes() {
            document.querySelectorAll('.note-container').forEach(el => el.remove());
            state.notes.forEach(note => displayNote(note));
        }

        function updateOpacities() {
            const allNotes = document.querySelectorAll('.note-container');
            const totalNotes = state.notes.length;
            const maxVisible = 20;
            
            allNotes.forEach((noteEl, index) => {
                const fromEnd = totalNotes - index - 1;
                if (fromEnd >= maxVisible) {
                    noteEl.style.opacity = '0';
                    noteEl.style.pointerEvents = 'none';
                } else {
                    const opacity = 0.3 + (0.7 * (maxVisible - fromEnd) / maxVisible);
                    noteEl.style.opacity = opacity;
                    noteEl.style.pointerEvents = 'auto';
                }
            });
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.target.contentEditable === 'true') return;
            
            switch(e.key.toLowerCase()) {
                case 'v': setTool('select'); break;
                case 'n': setTool('note'); break;
                case 'i': setTool('image'); break;
                case 'r': document.getElementById('zoomReset').click(); break;
                case '+': 
                case '=': document.getElementById('zoomIn').click(); break;
                case '-': document.getElementById('zoomOut').click(); break;
            }
        });

        // Prevent note clicks from bubbling
        canvas.addEventListener('click', (e) => {
            if (e.target.closest('.note-container')) {
                e.stopPropagation();
            }
        }, true);

        // Initialize
        loadNotes();
        updateTransform();
    </script>
</body>
</html>